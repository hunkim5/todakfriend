<!DOCTYPE html>
<html lang="ko"
		xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout/admin_layout}">

<th:block layout:fragment="script">
<script>
function changeView(val){
	$("#dataForm").attr("action",val);
	$("#dataForm").submit();
}
$(document).ready(function() {
	$('#commentFrm').on('submit', function (e) {
		sessionStorage.setItem('scrollPosition', $(window).scrollTop());
	    e.preventDefault();

	    const form = document.getElementById('commentFrm');
	    const formData = new FormData(form);
	    $.ajax({
	        url: "/admin/board/insertBoardComment",
	        type: "POST",
	        data: formData,
	        processData: false,
	        contentType: false,
	        success: function(res) {
	        	console.log(res);
	            alert("ì €ì¥ ì„±ê³µ!");
	            location.reload();
	        },
	        error: function(response) {
	            alert(response.responseText);
	        }
	    });
	}); //~ajax

	$('#likeBtn').click(function () {
	    let formData = $("#dataForm").serialize();
		$.ajax({
	        url: "/admin/board/updateLikeCnt",
	        data : formData,
	        type: "POST",
	        success: function(res) {
	        	console.log(">>>res:"+res);
	        	if(res ==0){
		        	let cnt = Number($("#likeCount").html());
		        	$("#likeCount").html(cnt+1);
	        	}else{
	        		alert("ì´ë¯¸ ì¶”ì²œ í•˜ì…¨ìŠµë‹ˆë‹¤.");
	        	}
	        },
	        error: function(response) {
	        }
	    });
	 });
});
function replyComment(commentSeq,val){
	let replyBox = $(val).closest('#commentList').find('.reply-box');
	if(replyBox.length == 0){
		$("#parentSeq").val(commentSeq);
		const replyHtml = `
		    <div class="reply-box mt-2">
		      <textarea class="form-control mb-2" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." id="commentReplyContent"></textarea>
		      <div class="d-flex justify-content-end">
		        <button class="btn btn-sm btn-primary me-2" onclick="commentReply()">ë“±ë¡</button>
		        <button class="btn btn-sm btn-outline-secondary" onclick="replyComment(this);">ì·¨ì†Œ</button>
		      </div>
		    </div>
		  `;
		  $(val).closest('div').append(replyHtml);
	}else{
		replyBox.remove();
	}
}
function commentReply() {
	// í¼ ì œì¶œ ì „ì— í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
    sessionStorage.setItem('scrollPosition', $(window).scrollTop());

	let formData = $("#dataForm").serialize();
	formData += "&content="+$("#commentReplyContent").val();
	$.ajax({
        url: "/web/insertBoardComment",
        data : formData,
        type: "POST",
        success: function(res) {
			location.reload();
        },
        error: function(response) {
        }
    });
}
function deleteComment(seq){
	if(!confirm("ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;
	$.ajax({
        url: "/admin/board/deleteBoardComment",
        data : "commentSeq="+seq,
        type: "POST",
        success: function(res) {
        	location.reload();
        },
        error: function(response) {
        }
    });
}
function updateBlind(blindYn){
	// í¼ ì œì¶œ ì „ì— í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
    sessionStorage.setItem('scrollPosition', $(window).scrollTop());

	let message = "ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
	if(blindYn){
		message = "ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ í•´ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
		blindYn=0;
	}else{
		blindYn=1;
	}
	if(!confirm(message))return;
	$.ajax({
        url: "/admin/board/updateBlind",
        data : "blindYn="+blindYn+"&boardSeq="+$("#boardSeq").val(),
        type: "POST",
        success: function(res) {
        	location.reload();
        },
        error: function(response) {
        }
    });
}
function updateCommentBlind(seq,blindYn){
	// í¼ ì œì¶œ ì „ì— í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥
    sessionStorage.setItem('scrollPosition', $(window).scrollTop());

	let message = "ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
	if(blindYn){
		message = "ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ í•´ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
		blindYn=0;
	}else{
		blindYn=1;
	}
	if(!confirm(message))return;
	$.ajax({
        url: "/admin/board/updateCommentBlind",
        data : "blindYn="+blindYn+"&commentSeq="+seq,
        type: "POST",
        success: function(res) {
        	location.reload();
        },
        error: function(response) {
        }
    });
}
</script>
</th:block>
<th:block layout:fragment="content">
<form id="dataForm" method="post">
<input type="hidden" name="page" th:value="${param.page}">
<input type="hidden" name="boardGubun" th:value="${param.boardGubun}">
<input type="hidden" name="boardSeq" id="boardSeq" th:value="${param.boardSeq}">
<input type="hidden" name="uuid" th:value="${data.uuid}">
<input type="hidden" name="searchOption" th:value="${param.searchOption}">
<input type="hidden" name="searchTitle" th:value="${param.searchTitle}">
<input type="hidden" name="parentSeq" id="parentSeq" >
<input type="hidden" name="boardTitle" th:value="${param.boardTitle}"/>
</form>
	<div class="card p-4">
		<h5 th:text="${data.title}">ğŸ“Œ ì‹œìŠ¤í…œ ì ê²€ ì•ˆë‚´</h5>
		<p class="text-muted">
			ì‘ì„±ì: <th:block th:text="${data.nickname}">ê´€ë¦¬ì</th:block> | ì‘ì„±ì¼: <th:block th:text="${#temporals.format(data.createDtm, 'yyyy-MM-dd HH:mm:ss')}"></th:block> | <i class="bi bi-eye"></i> ì¡°íšŒìˆ˜: <th:block th:text="${data.searchCnt}"></th:block>
		</p>
		<hr>
		<p th:utext="${data.content ?: ''}">ğŸš€ ì‹œìŠ¤í…œ ì ê²€ì´ 2025ë…„ 5ì›” 27ì¼ ì˜¤ì „ 3ì‹œë¶€í„° ì§„í–‰ë©ë‹ˆë‹¤.</p>

		<!-- ğŸ”¹ ê²Œì‹œê¸€ í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ -->
		<div class="mt-4 d-flex gap-2 justify-content-end">
			<button class="btn btn-outline-secondary btn-sm" onclick="changeView('list')">â† ëª©ë¡ìœ¼ë¡œ</button>
			<button class="btn btn-warning btn-sm" onclick="changeView('updateForm')">âœï¸ ìˆ˜ì •</button>
			<button class="btn btn-warning btn-sm" th:onclick="'updateBlind('+${data.blindYn}+')'" th:text="${data.blindYn}?'ë¸”ë¼ì¸ë“œí•´ì œ':'ë¸”ì•„ì¸ë“œì²˜ë¦¬'"></button>
			<button class="btn btn-outline-primary btn-sm" id="likeBtn">
				ğŸ‘ ì¶”ì²œ <span class="badge bg-primary ms-1" th:text="${data.likeCnt}" id="likeCount">12</span>
			</button>
		</div>
	</div>

	<div class="mt-4">
		<form id="commentFrm" th:action="@{/admin/board/insertBoardComment}" method="post">
		<input type="hidden" name="boardSeq" th:value="${data.boardSeq}" />
		<h4>ğŸ’¬ ëŒ“ê¸€</h4>
		<div class="card p-3 mb-3">
			<input type="text" class="form-control mb-2" placeholder="ëŒ“ê¸€ ì…ë ¥" name="content">
			<button class="btn btn-secondary btn-sm">ë“±ë¡</button>
		</div>
		</form>
		<!-- ëŒ“ê¸€ ëª©ë¡ -->
		<div class="comment-thread" id="commentList">
			<!-- ê³µí†µ í…œí”Œë¦¿: ëŒ“ê¸€ê³¼ ëŒ€ëŒ“ê¸€ ë™ì¼ êµ¬ì¡°, depthì— ë”°ë¼ ms-* ì¡°ì ˆ -->
			<div class="comment-item p-3 border rounded mb-2" th:each="comment : ${commentList}" th:style="'margin-left: ' + ${comment.depth * 10} + 'px;'" th:classappend="${comment.depth>0} ? 'bg-white' : 'bg-light'">
				<div class="fw-bold">
					<span th:text="${comment.depth>0}? |â¤·${comment.nickname}| : |ğŸ‘¤ ${comment.nickname}|">í™ê¸¸ë™</span>
					<span class="text-muted small">(2025-05-26)</span>
				</div>
				<div class="mt-1" th:utext="${comment.blindYn} ? ''+${comment.adminContent}+'(ë¸”ë¼ì¸ë“œì²˜ë¦¬ë¨)':''+${comment.adminContent}+''" th:style="${comment.blindYn} ? 'text-decoration: line-through;' : ''">ê°ì‚¬í•©ë‹ˆë‹¤!</div>
				<div class="comment-actions">
					<button class="btn btn-sm btn-link text-primary px-2" title="ë‹µê¸€" th:onclick="'replyComment(' + ${comment.commentSeq} + ',this)'" type="button">
						<i class="bi bi-reply"></i>
					</button>
					<button class="btn btn-sm btn-link text-danger px-2" title="ì‚­ì œ" th:onclick="'deleteComment(' + ${comment.commentSeq} + ')'" >
						<i class="bi bi-x-circle"></i>
					</button>
					<button class="btn btn-sm btn-link text-danger px-2" title="ë¸”ë¼ì¸ë“œ" th:onclick="'updateCommentBlind(' + ${comment.commentSeq} + ',' + ${comment.blindYn} + ')'">
						<i class="bi-eye-slash">ë¸”ë¼ì¸ë“œ</i>
					</button>
				</div>
			</div>
		</div>
	</div>
</th:block>